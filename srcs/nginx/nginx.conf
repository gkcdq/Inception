# La section 'main' est implicite.
# Les directives globales peuvent aller ici (comme user, worker_processes)

# ===============================================
# 1. Section OBLIGATOIRE : 'events'
# Cette section est requise pour que Nginx démarre.
# Elle configure le comportement du traitement des connexions.
# ===============================================
events {
    # Nombre de connexions simultanées que chaque processus de travail (worker process) peut gérer.
    worker_connections  1024;
}

# ===============================================
# 2. Section PRINCIPALE : 'http'
# Contient les directives pour le serveur web, y compris les virtual hosts (serveurs).
# ===============================================
http {
    # Inclusion des types MIME par défaut (important pour que le navigateur sache quoi afficher)
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Configuration des logs (facultatif, mais utile pour le débogage)
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Serveur HTTP pour rediriger vers HTTPS
    server {
        listen 80;
        server_name ${DOMAIN_NAME};

        # Rediriger tout le trafic HTTP vers HTTPS
        return 301 https://$server_name$request_uri;
    }

    # Serveur HTTPS (avec SSL configuré)
    server {
        listen 443 ssl;
        server_name ${DOMAIN_NAME};

        # Fichiers de certificats (Doivent être copiés dans le conteneur via le Dockerfile ou un volume)
        ssl_certificate /etc/ssl/certs/ssl-cert.pem;
        ssl_certificate_key /etc/ssl/private/ssl-cert.key;

        # Paramètres SSL recommandés
        ssl_protocols TLSv1.2 TLSv1.3;
        # ATTENTION: La liste des ciphers ci-dessous est tronquée. Vous devez fournir la liste complète.
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers on;

        # Sécurisation supplémentaire
        add_header X-Content-Type-Options nosniff always;
        add_header X-Frame-Options SAMEORIGIN always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

        # Répertoire de contenu pour WordPress
        root /var/www/html;
        index index.php index.html index.htm;

        # Configuration pour la gestion des fichiers statiques
        location / {
            try_files $uri $uri/ /index.php?$args;
        }

        # Configuration PHP (requêtes traitées par le conteneur WordPress via PHP-FPM)
        location ~ \.php$ {
            # Le nom du service 'wordpress' est utilisé comme host pour la connexion fastcgi
            fastcgi_pass wordpress:9000;
            fastcgi_index index.php;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        }
    }
}
